<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ç†Ÿé£Ÿæ€è²¨åŠ©æ‰‹</title>
    
    <!-- iOS Web App Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ç†Ÿé£Ÿæ€è²¨">
    
    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiB2aWV3Qm94PSIwIDAgMTgwIDE4MCI+CiAgPHJlY3Qgd2lkdGg9IjE4MCIgaGVpZ2h0PSIxODAiIHJ4PSIzNiIgZmlsbD0iIzAyODRjNyIvPgogIDxwYXRoIGQ9Ik00NSA2MEg4Nkw5MCA1MEgxNDBMMTQ1IDYwSDE1NVYxNDBIMzVWNjBINTVaIiBmaWxsPSJ3aGl0ZSIgb3BhY2l0eT0iMC4xIi8+CiAgPGcgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSI4IiBmaWxsPSJub25lIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPgogICAgPHBhdGggZD0iTTUwIDYwIEwxMzAgNjAgTDEzMCAxMzAgTDUwIDEzMCBaIiAvPgogICAgPHBhdGggZD0iTTUwIDkwIEwxMzAgOTAiIC8+CiAgICA8cGF0aCBkPSJNNTAgMTEwIEwxMzAgMTEwIiAvPgogICAgPHBhdGggZD0iTTgwIDYwIEw4MCAxMzAiIC8+CiAgPC9nPgo8L3N2Zz4=">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f0f2f5; 
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        .selectable { user-select: text; }
        .card { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); border-radius: 1rem; }
        
        ::-webkit-scrollbar { width: 0px; background: transparent; }

        .safe-top { padding-top: calc(env(safe-area-inset-top) + 1rem); }
        .safe-bottom { padding-bottom: calc(env(safe-area-inset-bottom) + 1rem); }

        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        #toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            transition: all 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            opacity: 0;
            pointer-events: none;
        }
        #toast.show { opacity: 1; bottom: 3rem; }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
            padding: 1rem;
            backdrop-filter: blur(4px);
        }
        .modal-overlay.active { display: flex; }
    </style>
</head>
<body class="safe-top safe-bottom px-4">

    <!-- é€šçŸ¥å°æ°£æ³¡ -->
    <div id="toast" class="bg-gray-800 text-white px-6 py-3 rounded-full text-sm font-medium shadow-2xl">
        æç¤ºè¨Šæ¯
    </div>

    <!-- API Key è¨­å®šå°è©±æ¡† -->
    <div id="apiKeyModal" class="modal-overlay">
        <div class="bg-white p-6 rounded-2xl w-full max-w-sm shadow-2xl fade-in">
            <h3 class="text-xl font-black text-gray-900 mb-2">ğŸ”‘ Gemini API è¨­å®š</h3>
            <p class="text-sm text-gray-500 mb-4">è«‹è¼¸å…¥æ‚¨çš„ Google AI API Keyã€‚æ­¤é‡‘é‘°åƒ…æœƒå„²å­˜åœ¨æ‚¨çš„è¨­å‚™ä¸Šï¼Œä¸æœƒå¤–æµã€‚</p>
            <input type="password" id="apiKeyInput" placeholder="åœ¨æ­¤ç²˜è²¼ API Key..." class="w-full p-4 bg-gray-100 border-none rounded-xl text-sm mb-6 focus:ring-2 focus:ring-blue-500">
            <div class="flex space-x-3">
                <button id="apiKeyCancel" class="flex-1 py-3 bg-gray-100 text-gray-700 font-bold rounded-xl active:scale-95 transition">å–æ¶ˆ</button>
                <button id="apiKeySave" class="flex-1 py-3 bg-blue-600 text-white font-bold rounded-xl active:scale-95 transition shadow-lg shadow-blue-200">å„²å­˜ä¸¦é–‹å§‹</button>
            </div>
            <p class="mt-4 text-[10px] text-gray-400 text-center">å¯åœ¨ Google AI Studio å…è²»å–å¾— Key</p>
        </div>
    </div>

    <!-- ä¸€èˆ¬æ“ä½œç¢ºèªå°è©±æ¡† -->
    <div id="confirmModal" class="modal-overlay">
        <div class="bg-white p-6 rounded-2xl w-full max-w-sm shadow-2xl">
            <h3 id="modalTitle" class="text-lg font-bold text-gray-900 mb-2">ç¢ºèªæ“ä½œ</h3>
            <p id="modalBody" class="text-sm text-gray-500 mb-6">æ‚¨ç¢ºå®šè¦åŸ·è¡Œæ­¤æ“ä½œå—ï¼Ÿ</p>
            <div class="flex space-x-3">
                <button id="modalCancel" class="flex-1 py-3 bg-gray-100 text-gray-700 font-bold rounded-xl active:scale-95 transition">å–æ¶ˆ</button>
                <button id="modalConfirm" class="flex-1 py-3 bg-red-500 text-white font-bold rounded-xl active:scale-95 transition">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <div class="container mx-auto max-w-5xl">
        <header class="flex justify-between items-end mb-6">
            <div class="flex items-center space-x-2">
                <h1 class="text-2xl font-black text-gray-900 tracking-tight">ğŸ£ ç†Ÿé£Ÿæ€è²¨</h1>
                <!-- è¨­å®šæŒ‰éˆ• -->
                <button id="openConfigBtn" class="p-1 text-gray-400 hover:text-gray-600 transition" title="API è¨­å®š">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                </button>
            </div>
            <div id="summary" class="hidden text-right">
                <span class="block text-[10px] text-gray-500 font-bold uppercase tracking-widest">ç¸½è¦½é ä¼°</span>
                <p class="text-sm font-bold text-blue-600"><span id="totalValidItems">0</span> é … / <span id="totalPallets">0</span> æ¿</p>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <aside class="lg:col-span-4 space-y-6">
                <section class="card bg-white p-5 border border-gray-100">
                    <h2 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4 flex items-center">
                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        ç´€éŒ„æŸ¥è©¢
                    </h2>
                    <select id="dateSelector" class="w-full p-3 bg-gray-50 border-none rounded-xl text-sm font-semibold focus:ring-2 focus:ring-blue-500">
                        <option value="">-- ç„¡ç´€éŒ„ --</option>
                    </select>
                    <p id="selectedDateDisplay" class="mt-3 text-lg font-black text-gray-800 h-8"></p>
                    <button id="deleteCurrentBtn" class="hidden mt-2 text-[10px] font-bold text-red-400 hover:text-red-600 transition">åˆªé™¤æ­¤æ—¥ç´€éŒ„</button>
                </section>

                <section class="card bg-blue-600 p-5 text-white shadow-blue-200">
                    <h2 class="text-xs font-bold opacity-80 uppercase tracking-widest mb-4 flex items-center">
                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4"></path></svg>
                        è¾¨è­˜æ–°æ¸…å–®
                    </h2>
                    <input type="file" id="fileInput" accept="image/*" class="hidden">
                    <label for="fileInput" class="block w-full border-2 border-dashed border-blue-400 rounded-xl p-4 text-center cursor-pointer hover:bg-blue-500 transition mb-4">
                        <div id="imagePreviewContainer" class="flex flex-col items-center">
                            <img id="imagePreview" src="" class="hidden max-h-32 rounded-lg mb-2 shadow-lg">
                            <span id="previewPlaceholder" class="text-xs font-bold">é»æ“Šä¸Šå‚³æ¸…å–®ç…§ç‰‡</span>
                        </div>
                    </label>
                    <button id="processButton" class="w-full py-4 bg-white text-blue-600 font-black rounded-xl shadow-xl hover:bg-gray-50 disabled:opacity-50 transition transform active:scale-95" disabled>
                        é–‹å§‹è¾¨è­˜
                    </button>
                    <div id="loadingIndicator" class="hidden mt-4 text-center">
                        <div class="inline-block animate-spin rounded-full h-4 h-4 border-2 border-white border-t-transparent mr-2"></div>
                        <span class="text-xs font-bold">AI æ­£åœ¨è®€å–æ•¸æ“š...</span>
                    </div>
                    <p id="error-message" class="text-red-200 mt-2 hidden text-[10px] font-bold text-center"></p>
                </section>
            </aside>

            <main class="lg:col-span-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xs font-bold text-gray-400 uppercase tracking-widest">å¾…è™•ç†è£æ¿æ¸…å–®</h2>
                    <button id="clearHistoryBtn" class="text-[10px] font-bold bg-red-50 text-red-500 px-3 py-1.5 rounded-lg hover:bg-red-100 transition">æ¸…é™¤æ‰€æœ‰æœ¬åœ°ç´€éŒ„</button>
                </div>

                <div id="outputContainer" class="space-y-6 fade-in">
                    <div class="bg-white rounded-2xl p-12 text-center border border-dashed border-gray-300">
                        <div class="bg-gray-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                        </div>
                        <p class="text-gray-400 text-sm font-medium">å°šæœªé¸æ“‡æˆ–è¾¨è­˜ä»»ä½•æ¸…å–®</p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script type="module">
        const CONFIG = {
            API_MODEL: "gemini-2.5-flash-preview-09-2025",
            API_URL_PREFIX: "https://generativelanguage.googleapis.com/v1beta/models/",
            MAX_RETRIES: 3,
            STORAGE_KEY: "COOKED_FOOD_PICKING_DATA",
            API_KEY_STORAGE_KEY: "GEMINI_API_KEY_LOCAL"
        };

        let currentManifestDateId = null;
        let confirmCallback = null;

        // --- UI å·¥å…· ---
        function showToast(msg) {
            const t = document.getElementById('toast');
            if (t) {
                t.textContent = msg;
                t.classList.add('show');
                setTimeout(() => t.classList.remove('show'), 3000);
            }
        }

        function showConfirm(title, body, callback) {
            const modal = document.getElementById('confirmModal');
            const t = document.getElementById('modalTitle');
            const b = document.getElementById('modalBody');
            if (modal && t && b) {
                t.textContent = title;
                b.textContent = body;
                modal.classList.add('active');
                confirmCallback = callback;
            }
        }

        function hideConfirm() {
            const modal = document.getElementById('confirmModal');
            if (modal) modal.classList.remove('active');
            confirmCallback = null;
        }

        // --- API Key ç®¡ç† ---
        function showApiKeyModal() {
            const modal = document.getElementById('apiKeyModal');
            const input = document.getElementById('apiKeyInput');
            if (modal) {
                modal.classList.add('active');
                if (input) input.value = localStorage.getItem(CONFIG.API_KEY_STORAGE_KEY) || "";
            }
        }

        function hideApiKeyModal() {
            const modal = document.getElementById('apiKeyModal');
            if (modal) modal.classList.remove('active');
        }

        // --- æœ¬åœ°å„²å­˜é‚è¼¯ ---
        function getLocalData() {
            try {
                const data = localStorage.getItem(CONFIG.STORAGE_KEY);
                return data ? JSON.parse(data) : {};
            } catch (e) {
                return {};
            }
        }

        function saveLocalData(allData) {
            localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(allData));
        }

        // --- æ ¸å¿ƒé‚è¼¯ï¼šæ›´æ–°å‹¾é¸ç‹€æ…‹ ---
        window.handlePick = function (itemId, isChecked) {
            if (!currentManifestDateId) return;
            const allData = getLocalData();
            const manifest = allData[currentManifestDateId];
            if (!manifest) return;

            if (!manifest.pickedState) manifest.pickedState = {};
            if (isChecked) manifest.pickedState[itemId] = true;
            else delete manifest.pickedState[itemId];
            
            saveLocalData(allData);
            renderResultsToDOM(manifest.processedResults, manifest.pickedState);
        };

        // --- æ¸²æŸ“ UI ---
        function renderResultsToDOM(results, pickedState) {
            const container = document.getElementById('outputContainer');
            const summary = document.getElementById('summary');
            const validSpan = document.getElementById('totalValidItems');
            const palletSpan = document.getElementById('totalPallets');
            
            if (!container) return;

            container.innerHTML = '';
            if (summary) summary.classList.remove('hidden');
            if (validSpan) validSpan.textContent = results.totalValidItems || 0;
            if (palletSpan) palletSpan.textContent = results.totalPallets || 0;

            const miscOrder = ["soy sauce", "ginger", "wasabi", "nori half", "nori full", "label", "labe", "sflm-2", "sbm-24c"];
            const sortedMisc = [...(results.MiscellaneousItems || [])].sort((a, b) => {
                const getRank = (item) => {
                    const name = item.item.toLowerCase();
                    for (let i = 0; i < miscOrder.length; i++) {
                        if (name.includes(miscOrder[i])) return i;
                    }
                    return 999;
                };
                return getRank(a) - getRank(b);
            });

            const palletConfigs = [
                { id: 'P1', items: results.Pallet1Items, name: "å»šæˆ¿å°ˆç”¨ (ç³–/é†‹/æ¡ƒ)", color: "violet", note: "ç¨ç«‹ä¸€æ¿" },
                { id: 'Misc', items: sortedMisc, name: "é›œé …æ¿ä½", color: "blue", note: "ä¾ç…§é †åºæ’åˆ—" },
                { id: 'P2', items: results.Pallet2Items, name: "ç”¢å“æ¿ä½ (BX-20 / BH-20)", color: "amber", note: `é è¨ˆ ${results.p2Pallets} æ¿` },
                { id: 'P3', items: results.Pallet3Items, name: "å–®ä½ã€Œæ¿ã€è²¨ç‰©", color: "emerald", note: "å–®ç¨æˆæ¿" }
            ];

            palletConfigs.forEach(pallet => {
                if (!pallet.items || pallet.items.length === 0) return;

                const totalInPallet = pallet.items.length;
                const checkedInPallet = pallet.items.filter(it => !!pickedState[it.id]).length;
                const progress = Math.round((checkedInPallet / totalInPallet) * 100);

                const palletCard = document.createElement('div');
                palletCard.className = `bg-white rounded-2xl p-5 mb-6 border-l-8 border-${pallet.color}-500 shadow-sm fade-in`;
                
                let html = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="font-black text-gray-800 text-sm md:text-base flex items-center">
                                ${pallet.name}
                                ${progress === 100 ? ' <span class="ml-2 text-green-500">âœ“</span>' : ''}
                            </h3>
                            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">${pallet.note}</p>
                        </div>
                        <div class="text-right">
                            <span class="text-xs font-black text-${pallet.color}-600">${progress}%</span>
                            <div class="w-20 h-1.5 bg-gray-100 rounded-full mt-1 overflow-hidden">
                                <div class="h-full bg-${pallet.color}-500 transition-all duration-500" style="width: ${progress}%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-2">
                `;

                pallet.items.forEach(item => {
                    const isChecked = !!pickedState[item.id];
                    html += `
                        <label class="flex items-center p-3 rounded-xl border ${isChecked ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-transparent'} transition-all active:scale-[0.98]">
                            <input type="checkbox" class="w-5 h-5 rounded-lg border-gray-300 text-${pallet.color}-600 focus:ring-${pallet.color}-500" 
                                onchange="window.handlePick('${item.id}', this.checked)" ${isChecked ? 'checked' : ''}>
                            <div class="ml-3 flex-1">
                                <p class="text-sm font-bold ${isChecked ? 'text-gray-400 line-through' : 'text-gray-700'}">${item.item}</p>
                            </div>
                            <div class="text-right">
                                <span class="text-xs font-black text-gray-900">${item.qty}</span>
                                <span class="text-[10px] font-bold text-gray-400 uppercase">${item.uom}</span>
                            </div>
                        </label>
                    `;
                });

                palletCard.innerHTML = html + `</div>`;
                container.appendChild(palletCard);
            });
        }

        // --- åˆ·æ–°æ¸…å–® ---
        function fetchAvailableDates() {
            const dateSelector = document.getElementById('dateSelector');
            const delBtn = document.getElementById('deleteCurrentBtn');
            const container = document.getElementById('outputContainer');
            const summary = document.getElementById('summary');
            const dateDisplay = document.getElementById('selectedDateDisplay');
            
            if (!dateSelector) return;

            const allData = getLocalData();
            const dateIds = Object.keys(allData).sort((a, b) => new Date(b) - new Date(a));

            if (dateIds.length > 0) {
                dateSelector.innerHTML = '<option value="">-- é¸æ“‡æ—¥æœŸ --</option>';
                dateIds.forEach(id => {
                    const opt = document.createElement('option');
                    opt.value = id; opt.textContent = allData[id].formattedDate;
                    dateSelector.appendChild(opt);
                });
                
                if (currentManifestDateId && allData[currentManifestDateId]) {
                    dateSelector.value = currentManifestDateId;
                } else {
                    dateSelector.value = dateIds[0];
                    currentManifestDateId = dateIds[0];
                }
                
                loadManifestByDate(currentManifestDateId);
                if (delBtn) delBtn.classList.remove('hidden');
            } else {
                dateSelector.innerHTML = '<option value="">-- ç„¡ç´€éŒ„ --</option>';
                if (container) container.innerHTML = '<div class="bg-white rounded-2xl p-12 text-center border border-dashed border-gray-300"><p class="text-gray-400 text-sm font-medium">å°šæœªé¸æ“‡æˆ–è¾¨è­˜ä»»ä½•æ¸…å–®</p></div>';
                if (summary) summary.classList.add('hidden');
                if (dateDisplay) dateDisplay.textContent = '';
                if (delBtn) delBtn.classList.add('hidden');
                currentManifestDateId = null;
            }
        }

        function loadManifestByDate(dateId) {
            const allData = getLocalData();
            const manifest = allData[dateId];
            if (manifest) {
                currentManifestDateId = dateId;
                renderResultsToDOM(manifest.processedResults, manifest.pickedState || {});
                const display = document.getElementById('selectedDateDisplay');
                if (display) display.textContent = manifest.formattedDate;
            }
        }

        // --- AI è¾¨è­˜ ---
        async function processImage(file) {
            const userApiKey = localStorage.getItem(CONFIG.API_KEY_STORAGE_KEY);
            if (!userApiKey) {
                showApiKeyModal();
                throw new Error("è«‹å…ˆè¨­å®š API Key");
            }

            const base64 = await new Promise(r => {
                const reader = new FileReader();
                reader.onload = () => r(reader.result.split(',')[1]);
                reader.readAsDataURL(file);
            });
            
            const prompt = "Extract Date, Item, UoM, Qty where Qty > 0. Response JSON format: {date: string, items: Array<{item: string, uom: string, qty: number}>}";
            const schema = { type:"OBJECT", properties:{ date:{type:"STRING"}, items:{type:"ARRAY", items:{type:"OBJECT", properties:{item:{type:"STRING"}, uom:{type:"STRING"}, qty:{type:"NUMBER"}}, required:["item","uom","qty"]}}}, required:["date","items"]};
            const url = `${CONFIG.API_URL_PREFIX}${CONFIG.API_MODEL}:generateContent?key=${userApiKey}`;
            
            const response = await fetch(url, {
                method: 'POST',
                body: JSON.stringify({ contents:[{parts:[{text:prompt}, {inlineData:{mimeType:file.type, data:base64}}]}], generationConfig:{responseMimeType:"application/json", responseSchema:schema} })
            });
            
            if (!response.ok) {
                if (response.status === 403 || response.status === 400) {
                    showToast("API Key ç„¡æ•ˆæˆ–éæœŸï¼Œè«‹é‡æ–°è¨­å®š");
                    showApiKeyModal();
                }
                throw new Error("è¾¨è­˜å¤±æ•—");
            }
            
            const res = await response.json();
            const data = JSON.parse(res.candidates[0].content.parts[0].text);
            const items = data.items.map((it, idx) => ({ ...it, id: `item-${Date.now()}-${idx}` }));
            
            const p1 = items.filter(i => {
                const n = i.item.toLowerCase();
                return n.includes("sugar") || n.includes("vinegar") || n.includes("peach") || n.includes("ç³–") || n.includes("é†‹") || n.includes("æ¡ƒ");
            });
            const p2 = items.filter(i => !p1.includes(i) && ["BH-20", "BX-20", "Sushi Tray"].some(k => i.item.toUpperCase().includes(k)));
            const p3 = items.filter(i => !p1.includes(i) && !p2.includes(i) && i.uom === "æ¿");
            const misc = items.filter(i => !p1.includes(i) && !p2.includes(i) && !p3.includes(i));
            
            const p2Qty = p2.reduce((s,i) => s+i.qty, 0);
            const p2Pallets = Math.ceil(p2Qty / 31);
            const p3Pallets = p3.reduce((s,i) => s+i.qty, 0);
            const total = (p1.length?1:0) + p2Pallets + p3Pallets + (misc.length?1:0);

            const results = { Pallet1Items:p1, Pallet2Items:p2, Pallet3Items:p3, MiscellaneousItems:misc, totalValidItems:items.length, totalPallets:total, p2Pallets };
            const formattedDate = new Date(data.date).toLocaleDateString('zh-Hant', { year:'numeric', month:'long', day:'numeric', weekday:'long' }).replace(' ', ' (').concat(')');
            
            const allData = getLocalData();
            allData[data.date] = { dateId: data.date, formattedDate, processedResults: results, pickedState: {} };
            saveLocalData(allData);
            
            currentManifestDateId = data.date;
            showToast('è¾¨è­˜å®Œæˆä¸¦å­˜å…¥æœ¬åœ°');
            fetchAvailableDates();
        }

        // --- åˆå§‹åŒ–äº‹ä»¶ ---
        document.addEventListener('DOMContentLoaded', () => {
            const fInput = document.getElementById('fileInput');
            const pBtn = document.getElementById('processButton');
            const lInd = document.getElementById('loadingIndicator');
            const dateSel = document.getElementById('dateSelector');
            const clearBtn = document.getElementById('clearHistoryBtn');
            const deleteCurBtn = document.getElementById('deleteCurrentBtn');
            const modalConfirm = document.getElementById('modalConfirm');
            const modalCancel = document.getElementById('modalCancel');
            const errDiv = document.getElementById('error-message');
            const configBtn = document.getElementById('openConfigBtn');
            const apiKeyInput = document.getElementById('apiKeyInput');
            const apiKeySave = document.getElementById('apiKeySave');
            const apiKeyCancel = document.getElementById('apiKeyCancel');

            // æª¢æŸ¥æ˜¯å¦å·²æœ‰ API Key
            if (!localStorage.getItem(CONFIG.API_KEY_STORAGE_KEY)) {
                showApiKeyModal();
            }

            if (fInput) {
                fInput.addEventListener('change', e => {
                    const file = e.target.files[0];
                    if (file) {
                        const r = new FileReader(); r.onload = ev => { 
                            const img = document.getElementById('imagePreview');
                            const ph = document.getElementById('previewPlaceholder');
                            if (img) { img.src = ev.target.result; img.classList.remove('hidden'); }
                            if (ph) ph.classList.add('hidden'); 
                            if (pBtn) pBtn.disabled = false; 
                        };
                        r.readAsDataURL(file);
                    }
                });
            }

            if (pBtn) {
                pBtn.addEventListener('click', async () => {
                    if (errDiv) errDiv.classList.add('hidden');
                    if (lInd) lInd.classList.remove('hidden'); 
                    pBtn.disabled = true;
                    try { await processImage(fInput.files[0]); } 
                    catch (e) { if (errDiv) { errDiv.textContent = "è¾¨è­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç…§ç‰‡æˆ– API Key"; errDiv.classList.remove('hidden'); } }
                    if (lInd) lInd.classList.add('hidden'); 
                    pBtn.disabled = false;
                });
            }

            if (dateSel) {
                dateSel.addEventListener('change', e => { 
                    if (e.target.value) {
                        currentManifestDateId = e.target.value;
                        loadManifestByDate(currentManifestDateId); 
                    }
                });
            }

            if (clearBtn) {
                clearBtn.addEventListener('click', () => {
                    showConfirm('æ¸…é™¤æ‰€æœ‰ç´€éŒ„', 'ç¢ºå®šè¦æ¸…é™¤é€™å°è¨­å‚™ä¸Šã€Œæ‰€æœ‰çš„ã€æ€è²¨ç´€éŒ„å—ï¼Ÿé€™å°‡ç„¡æ³•é‚„åŸã€‚', () => {
                        localStorage.removeItem(CONFIG.STORAGE_KEY);
                        currentManifestDateId = null;
                        fetchAvailableDates();
                        showToast('æ­·å²ç´€éŒ„å·²å®Œå…¨æ¸…ç©º');
                    });
                });
            }

            if (deleteCurBtn) {
                deleteCurBtn.addEventListener('click', () => {
                    if (!currentManifestDateId) return;
                    const allData = getLocalData();
                    const dateToDel = currentManifestDateId;
                    const dateText = allData[dateToDel] ? allData[dateToDel].formattedDate : dateToDel;
                    
                    showConfirm('åˆªé™¤å–®ä¸€ç´€éŒ„', `ç¢ºå®šè¦åˆªé™¤ ${dateText} çš„ç´€éŒ„å—ï¼Ÿ`, () => {
                        const data = getLocalData();
                        if (data[dateToDel]) {
                            delete data[dateToDel];
                            saveLocalData(data);
                            currentManifestDateId = null;
                            fetchAvailableDates();
                            showToast('å–®æ—¥ç´€éŒ„å·²åˆªé™¤');
                        }
                    });
                });
            }

            // API Key è¨­å®šç›¸é—œ
            if (configBtn) configBtn.addEventListener('click', showApiKeyModal);
            if (apiKeyCancel) apiKeyCancel.addEventListener('click', hideApiKeyModal);
            if (apiKeySave) {
                apiKeySave.addEventListener('click', () => {
                    const val = apiKeyInput.value.trim();
                    if (val) {
                        localStorage.setItem(CONFIG.API_KEY_STORAGE_KEY, val);
                        hideApiKeyModal();
                        showToast("API Key å·²å„²å­˜");
                    } else {
                        showToast("è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡‘é‘°");
                    }
                });
            }

            // å½ˆçª—ç¢ºèªè™•ç†
            if (modalCancel) modalCancel.addEventListener('click', hideConfirm);
            if (modalConfirm) {
                modalConfirm.addEventListener('click', () => {
                    if (confirmCallback) confirmCallback();
                    hideConfirm();
                });
            }

            fetchAvailableDates();
        });
    </script>
</body>
</html>
